// scripts/generate-from-csv.mjs
import fs from "node:fs";
import path from "node:path";
import { fileURLToPath } from "node:url";
import { parse } from "csv-parse/sync";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const CSV_PATH = path.resolve(__dirname, "../src/iso-mapping-3166.csv");
const OUT_PATH = path.resolve(__dirname, "../src/data.js");

// Read + parse CSV (handles quoted fields)
const csv = fs.readFileSync(CSV_PATH, "utf8");
const rows = parse(csv, {
    columns: true,
    skip_empty_lines: true,
    trim: true
});

// Build maps
const ISO2_TO_3 = {};
const ISO2_TO_N3 = {};
const ISO2_TO_DIAL = {}; // string dial code as-is from CSV (e.g., "1-242", "44", "970")

for (const r of rows) {
    const a2 = r["Alpha-2 code"]?.toUpperCase().trim();
    const a3 = r["Alpha-3 code"]?.toUpperCase().trim();
    const n = String(r["Numeric"] ?? "").trim().padStart(3, "0");
    const dialRaw = String(r["Dial Codes"] ?? "").trim();
    if (!a2 || !a3 || !/^\d{1,3}$/.test(String(r["Numeric"]))) continue;

    ISO2_TO_3[a2] = a3;
    ISO2_TO_N3[a2] = n;
    if (dialRaw) ISO2_TO_DIAL[a2] = dialRaw;
}

// Aliases (documented behavior)
ISO2_TO_3.UK = "GBR";                // common alias for GB
ISO2_TO_3.XK = "XKX";                // Kosovo (user-assigned)
ISO2_TO_3.EL = "GRC";                // Greece (EU context)

ISO2_TO_N3.UK = ISO2_TO_N3.GB;       // "826"
ISO2_TO_N3.EL = ISO2_TO_N3.GR;       // "300"
ISO2_TO_N3.XK = "383";               // common numeric for XK (user-assigned)

// Dial code aliases
if (ISO2_TO_DIAL.GB) ISO2_TO_DIAL.UK = ISO2_TO_DIAL.GB;  // UK alias → same as GB (e.g., "44")
if (ISO2_TO_DIAL.GR) ISO2_TO_DIAL.EL = ISO2_TO_DIAL.GR;  // EL alias → same as GR ("30")
ISO2_TO_DIAL.XK = ISO2_TO_DIAL.XK || "383";              // Kosovo commonly uses +383

// Reverse maps
const ISO3_TO_2 = Object.fromEntries(Object.entries(ISO2_TO_3).map(([a2, a3]) => [a3, a2]));
const N3_TO_2 = Object.fromEntries(Object.entries(ISO2_TO_N3).map(([a2, n]) => [n, a2]));
// Build reverse dial -> ISO2; then canonicalize alias values to canonical A2
const DIAL_TO_2 = Object.fromEntries(
    Object.entries(ISO2_TO_DIAL).map(([a2, dial]) => [dial, a2])
);
// Ensure canonical A2 in reverse (e.g., '44' -> 'GB', not 'UK')
for (const [dial, a2] of Object.entries(DIAL_TO_2)) {
    if (a2 === "UK") DIAL_TO_2[dial] = "GB";
    else if (a2 === "EL") DIAL_TO_2[dial] = "GR";
}

// Emit JS module
const header = `// ⚠️ AUTO-GENERATED by scripts/generate-from-csv.mjs
// Source: src/iso-mapping-3166.csv
// Do not edit this file manually—edit the CSV and re-run the generator.
`;

const js = `${header}
export const ISO2_TO_3 = ${JSON.stringify(ISO2_TO_3, null, 2)};

export const ISO2_TO_N3 = ${JSON.stringify(ISO2_TO_N3, null, 2)};

export const ISO3_TO_2 = ${JSON.stringify(ISO3_TO_2, null, 2)};
export const N3_TO_2   = ${JSON.stringify(N3_TO_2, null, 2)};
export const ISO2_TO_DIAL = ${JSON.stringify(ISO2_TO_DIAL, null, 2)};
export const DIAL_TO_2    = ${JSON.stringify(DIAL_TO_2, null, 2)};
`;

fs.writeFileSync(OUT_PATH, js, "utf8");
console.log(`Generated: ${path.relative(process.cwd(), OUT_PATH)}`);